AWSTemplateFormatVersion: "2010-09-09"
Description: "Deploys the client (React app) via S3 + CloudFront"

Parameters:
  EnvId:
    Type: String
    Description: Environment Id for namespacing resources.

  DomainName:
    Type: String
    Description: The main domain name (e.g., example.com).

  InfraArtifactsBucket:
    Type: String
    Description: The S3 bucket where the build artifact (zip) is stored.

  ClientArtifactS3Key:
    Type: String
    Description: The S3 key path to the built client zip file.

  WebCertArn:
    Type: String
    Description: ARN of the ACM certificate for HTTPS.

Resources:
  # --- Static Website Bucket ---
  ClientBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${EnvId}-client-${AWS::Region}-${AWS::AccountId}"
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: EnvId
          Value: !Ref EnvId

  # --- CloudFront Origin Access Control ---
  ClientOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${EnvId}-client-oac"
        Description: "Access control for CloudFront to access S3 bucket"
        SigningProtocol: sigv4
        SigningBehavior: always
        OriginAccessControlOriginType: s3

  # --- CloudFront Distribution ---
  ClientDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub "Client distribution for ${EnvId}"
        DefaultRootObject: index.html
        Aliases:
          - !Ref DomainName
          - !Sub "www.${DomainName}"
        ViewerCertificate:
          AcmCertificateArn: !Ref WebCertArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
          - Id: ClientS3Origin
            DomainName: !GetAtt ClientBucket.RegionalDomainName
            S3OriginConfig: {}
            OriginAccessControlId: !Ref ClientOriginAccessControl
        DefaultCacheBehavior:
          TargetOriginId: ClientS3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET", "HEAD", "OPTIONS"]
          CachedMethods: ["GET", "HEAD"]
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
        PriceClass: PriceClass_100
        HttpVersion: http2
        IPV6Enabled: true
        CustomErrorResponses:
          - ErrorCode: 404
            ResponsePagePath: /index.html
            ResponseCode: 200
            ErrorCachingMinTTL: 0

  # --- Deployment Lambda (copies artifact to bucket) ---
  DeployClientLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${EnvId}-deploy-client"
      Role: !GetAtt DeployClientLambdaRole.Arn
      Runtime: python3.11
      Handler: index.handler
      Timeout: 300
      Environment:
        Variables:
          TARGET_BUCKET: !Ref ClientBucket
          ARTIFACT_BUCKET: !Ref InfraArtifactsBucket
          ARTIFACT_KEY: !Ref ClientArtifactS3Key
      Code:
        ZipFile: |
          import boto3, zipfile, io, os, json, urllib3
          s3 = boto3.client('s3')
          http = urllib3.PoolManager()

          def send_response(event, context, status, reason=None):
              response_body = json.dumps({
                  "Status": status,
                  "Reason": reason or "See CloudWatch logs for details",
                  "PhysicalResourceId": context.log_stream_name,
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
              })
              http.request("PUT", event["ResponseURL"], body=response_body)

          def handler(event, context):
              print("Received event:", json.dumps(event))
              req_type = event.get("RequestType")

              if req_type == "Delete":
                  send_response(event, context, "SUCCESS", "No-op on delete")
                  return

              try:
                  target_bucket = os.environ['TARGET_BUCKET']
                  artifact_bucket = os.environ['ARTIFACT_BUCKET']
                  artifact_key = os.environ['ARTIFACT_KEY']

                  print(f"Deploying client from s3://{artifact_bucket}/{artifact_key} to {target_bucket}")
                  obj = s3.get_object(Bucket=artifact_bucket, Key=artifact_key)

                  with zipfile.ZipFile(io.BytesIO(obj['Body'].read())) as z:
                      for name in z.namelist():
                          if name.endswith('/'):
                              continue
                          # Strip top-level folder if exists
                          parts = name.split('/', 1)
                          key = parts[1] if len(parts) == 2 else parts[0]
                          content = z.read(name)
                          put_kwargs = {
                              "Bucket": target_bucket,
                              "Key": key,
                              "Body": content
                          }
                          if key.endswith('.html'):
                              put_kwargs["ContentType"] = "text/html"
                          s3.put_object(**put_kwargs)

                  send_response(event, context, "SUCCESS")

              except Exception as e:
                  print("Error during deployment:", str(e))
                  send_response(event, context, "FAILED", str(e))

  DeployClientLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${EnvId}-deploy-client-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeployClientAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub "arn:aws:s3:::${InfraArtifactsBucket}/*"
                  - !Sub "arn:aws:s3:::${ClientBucket}/*"

  # --- Custom Resource to Trigger Deployment ---
  ClientDeploymentTrigger:
    Type: Custom::DeployClient
    Properties:
      ServiceToken: !GetAtt DeployClientLambda.Arn

Outputs:
  ClientBucketName:
    Description: Name of the S3 bucket where static files are hosted
    Value: !Ref ClientBucket

  CloudFrontDomain:
    Description: The CloudFront distribution domain name
    Value: !GetAtt ClientDistribution.DomainName
